-- Skema database ini dirancang untuk PostgreSQL (digunakan oleh Supabase)
-- untuk menangani pengguna, iklan perumahan, dan gambar.

-- 1. Membuat Tipe ENUM kustom untuk status iklan
-- Di PostgreSQL, ENUM adalah tipe data terpisah
CREATE TYPE ad_status_enum AS ENUM ('active', 'inactive', 'sold');

-- 2. Tabel Users
-- Tabel ini menyimpan informasi dasar pengguna yang mendaftar.
CREATE TABLE IF NOT EXISTS "Users" (
    "user_id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "full_name" VARCHAR(100) NOT NULL,
    "email" VARCHAR(100) NOT NULL UNIQUE,
    "password_hash" VARCHAR(255) NOT NULL, -- Simpan hash bcrypt
    "phone_number" VARCHAR(20) NOT NULL,
    "created_at" TIMESTAMPTZ DEFAULT now()
);

COMMENT ON TABLE "Users" IS 'Menyimpan data pengguna yang terdaftar';

-- 3. Tabel HousingAds
-- Tabel ini menyimpan semua detail untuk setiap iklan perumahan.
CREATE TABLE IF NOT EXISTS "HousingAds" (
    "ad_id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id" BIGINT NOT NULL,               -- Foreign Key untuk link ke pengguna
    
    -- Detail Utama Iklan
    "title" VARCHAR(255) NOT NULL,
    "description" TEXT,
    "price" DECIMAL(15, 2) NOT NULL,
    "status" ad_status_enum DEFAULT 'active', -- Menggunakan tipe ENUM yang sudah dibuat

    -- Parameter Properti
    "address" VARCHAR(255) NOT NULL,
    "city" VARCHAR(100),
    "province" VARCHAR(100),
    "postal_code" VARCHAR(10),
    "latitude" DECIMAL(10, 7),               -- Untuk integrasi peta
    "longitude" DECIMAL(10, 7),              -- Untuk integrasi peta
    "land_size_sqm" DECIMAL(10, 2),
    "building_size_sqm" DECIMAL(10, 2),
    "bedrooms" SMALLINT NOT NULL,
    "bathrooms" SMALLINT NOT NULL,
    "garage_capacity" SMALLINT DEFAULT 0,
    "facilities" TEXT,                       -- Bisa diisi sebagai JSONB jika mau
                                             -- Contoh: '["Kolam Renang", "Taman"]'::jsonb

    -- Info Kontak per Iklan
    "contact_phone" VARCHAR(20) NOT NULL,

    -- Timestamps
    "created_at" TIMESTAMPTZ DEFAULT now(),
    "updated_at" TIMESTAMPTZ DEFAULT now(),  -- Akan di-update oleh trigger

    -- Mendefinisikan Foreign Key
    FOREIGN KEY ("user_id") REFERENCES "Users"("user_id") ON DELETE CASCADE
);

COMMENT ON TABLE "HousingAds" IS 'Menyimpan detail setiap iklan perumahan';
COMMENT ON COLUMN "HousingAds"."facilities" IS 'Fasilitas, bisa diisi sebagai JSON array string (JSONB direkomendasikan)';


-- 4. Tabel AdImages
-- Tabel ini menyimpan URL gambar dari Cloudinary untuk setiap iklan.
CREATE TABLE IF NOT EXISTS "AdImages" (
    "image_id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "ad_id" BIGINT NOT NULL,                 -- Foreign Key untuk link ke iklan
    
    -- Info Cloudinary
    "cloudinary_url" VARCHAR(255) NOT NULL,
    "cloudinary_public_id" VARCHAR(255),
    
    "is_primary" BOOLEAN DEFAULT FALSE,
    "uploaded_at" TIMESTAMPTZ DEFAULT now(),

    -- Mendefinisikan Foreign Key
    FOREIGN KEY ("ad_id") REFERENCES "HousingAds"("ad_id") ON DELETE CASCADE
);

COMMENT ON TABLE "AdImages" IS 'Menyimpan URL gambar Cloudinary untuk setiap iklan';
COMMENT ON COLUMN "AdImages"."cloudinary_public_id" IS 'Public ID untuk manajemen (misal: menghapus gambar)';


-- 5. Trigger untuk auto-update kolom 'updated_at'
-- PostgreSQL memerlukan fungsi trigger untuk meng-handle 'ON UPDATE'

-- Membuat fungsi trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now(); -- Mengatur 'updated_at' ke waktu saat ini
    RETURN NEW;   -- Mengembalikan baris yang dimodifikasi
END;
$$ language 'plpgsql';

-- Menerapkan trigger ke tabel HousingAds
-- Trigger ini akan aktif setiap kali ada 'UPDATE' pada baris di tabel 'HousingAds'
CREATE TRIGGER trigger_update_housingads_updated_at
BEFORE UPDATE ON "HousingAds"
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();